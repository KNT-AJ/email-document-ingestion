# Redis Configuration for Email & Document Ingestion System
# Optimized for Celery message broker and result backend usage

# Network Configuration
bind 0.0.0.0
port 6379
timeout 0
tcp-keepalive 300

# General Configuration
daemonize no
supervised systemd
loglevel notice
logfile /var/log/redis/redis-server.log

# Memory Management (256MB limit for development, adjust for production)
maxmemory 256mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Persistence Configuration
# Enable AOF persistence for data durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# RDB Snapshotting (disabled since we're using AOF)
save ""

# Security Configuration
# Require password authentication (set via environment variable)
requirepass ${REDIS_PASSWORD:-}

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command SHUTDOWN SHUTDOWN_REDIS
rename-command CONFIG CONFIG_REDIS

# Connection Limits
maxclients 10000
maxclients-timeout 300

# Database Configuration
# Use separate databases for different environments
databases 16

# Replication (disabled for single instance setup)
# replicaof <masterip> <masterport>
# masterauth <master-password>

# Cluster (disabled for single instance setup)
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 5000

# Performance Tuning
# Disable THP (Transparent Huge Pages) warnings
disable-thp yes

# Increase file descriptor limit
maxclients 4096

# Connection backlog
tcp-backlog 511

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Slow log configuration
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 100

# Keyspace notifications (for monitoring)
notify-keyspace-events Ex

# Lua scripting
lua-time-limit 5000

# Advanced Configuration
# Active defragmentation (Redis 4.0+)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# IO Threads (Redis 6.0+)
io-threads 4
io-threads-do-reads yes

# Append-only file rewrite
aof-rewrite-incremental-fsync yes
aof-load-truncated yes
